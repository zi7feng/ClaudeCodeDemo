# ADR-006: Production Bug Fixes for Authentication and Internationalization

## Revision Log
| Date | Description |
|------|-------------|
| 2025-12-11 | Document created |
| 2025-12-11 | Added deeper Flask-Session logout bug analysis and final fix |

## Context
Three production issues were identified during initial deployment: (1) page refresh causing automatic logout due to 401 interceptor behavior, (2) Flask-Session 0.5.0 throwing TypeError on NULL expiry values, and (3) incomplete internationalization with hardcoded English strings across multiple components.

## Decision
We implement three bug fixes: (1) exclude /auth/me endpoint from automatic 401 redirect using URL.pathname matching, (2) clean up sessions with NULL expiry at application startup as a workaround for Flask-Session 0.5.0 bug, and (3) add comprehensive translation keys for all hardcoded strings with English and Chinese language support.

## Consequences

### Benefits
- Users no longer experience automatic logout on page refresh
- Application starts successfully without TypeError from Flask-Session
- Complete internationalization support eliminates language mixing issues
- URL path parsing prevents false positives from query parameters
- Session cleanup runs once at startup with minimal performance impact
- All user-facing text is now translatable

### Tradeoffs
- /auth/me endpoint 401 errors require separate handling in AuthContext
- Session cleanup workaround is a band-aid until Flask-Session 0.5.1 release
- Additional translation files increase bundle size marginally
- URL parsing adds slight overhead to 401 interceptor
- Startup time increases minimally due to session cleanup query
- Translation maintenance requires updates in multiple locale files

## Implementation
1. Modify frontend 401 interceptor to parse request URL and exclude /auth/me pathname
2. Add session cleanup query in Flask application factory after db.create_all()
3. Extract all hardcoded strings and create translation keys
4. Add translation entries to en.json and zh.json locale files
5. Update components to use t() function for all user-facing text
6. Log warning message when sessions are deleted at startup

## Related Decisions
- **Extends**: ADR-002 - Session-Based Authentication (fixes enhance authentication reliability)

## Appendix: 401 Interceptor Fix

### Problem
Original interceptor used string matching that failed to properly exclude /auth/me:

```typescript
// Original problematic code
if (!error.config?.url?.endsWith('/auth/me')) {
  window.location.href = '/login';
}
```

This approach failed when query parameters were present and couldn't distinguish between relative and absolute URLs.

### Solution
Parse URL to extract pathname for accurate comparison:

```typescript
// frontend/src/api/client.ts
apiClient.interceptors.response.use(
  (response) => response,
  (error: AxiosError) => {
    if (error.response?.status === 401) {
      // Exclude /auth/me from automatic redirect to let AuthContext handle it
      // Use URL path matching instead of string ending to handle query parameters
      const requestUrl = error.config?.url || '';
      const urlPath = new URL(requestUrl, window.location.origin).pathname;
      if (urlPath !== '/auth/me') {
        window.location.href = '/login';
      }
    }
    return Promise.reject(error);
  }
);
```

## Appendix: Flask-Session 0.5.0 NULL Expiry Bug Analysis and Fix

### Initial Symptom
Flask-Session 0.5.0 contains a bug in `flask_session/sessions.py` at line 525 where session expiry is compared with datetime without NULL checking:

```python
# Problematic code in flask_session 0.5.0
if session.expiry < datetime.utcnow():  # Crashes if expiry is NULL
    return None
```

### Deeper Root Cause Analysis
The initial analysis focused on startup-time cleanup of NULL expiry sessions, but the actual problem occurs **at runtime** during the logout flow:

1. **Logout Flow Bug Chain**:
   - User logs in successfully (session has user_id, permanent=True)
   - User clicks logout, calling `session.clear()`
   - `clear()` method resets `session.permanent` to False
   - `@after_request` hook (in `__init__.py`) adds csrf_token to session
   - Flask-Session 0.5.0 saves session with `permanent=False`, causing `get_expiration_time()` to return None
   - Session record saved to database with expiry=NULL
   - Next request calls `open_session()` which attempts `NULL <= datetime.utcnow()` â†’ TypeError

2. **Why NULL Expiry Sessions Are Created**:
   - `session.clear()` resets permanent flag to False
   - Subsequent session writes (e.g., csrf_token) with permanent=False generate NULL expiry
   - This is a design flaw in Flask-Session 0.5.0's interaction with session lifecycle

### Final Fix Implementation
The correct fix addresses the logout flow by preserving session permanence:

```python
# backend/app/routes/auth.py
@auth_bp.route('/logout', methods=['POST'])
def logout():
    session.clear()
    session.permanent = True  # Must be AFTER clear() because clear() resets permanent
    return jsonify({'message': 'Logout successful'}), 200
```

**Critical Ordering**:
- `session.clear()` must come first (removes user_id and other data)
- `session.permanent = True` must come second (ensures valid expiry even if @after_request adds data)
- This guarantees Flask-Session calculates a valid expiry when saving the session

### Startup Cleanup (Historical Data)
The startup cleanup logic is retained to handle legacy NULL expiry sessions created before the fix:

```python
# backend/app/__init__.py
def create_app(config_name=None):
    # ... initialization code ...

    with app.app_context():
        db.create_all()

        # Clean up invalid session records (Flask-Session 0.5.0 bug workaround)
        # Sessions with NULL expiry cause TypeError when compared with datetime
        try:
            result = db.session.execute(text("DELETE FROM sessions WHERE expiry IS NULL"))
            deleted_count = result.rowcount
            db.session.commit()
            if deleted_count > 0:
                logger.warning(f"Flask-Session 0.5.0 workaround: Deleted {deleted_count} sessions with NULL expiry")
        except Exception as e:
            logger.error(f"Error during session cleanup: {e}")
            db.session.rollback()

    return app
```

### Complete Fix Summary
- **Runtime Fix**: Set `session.permanent = True` after `session.clear()` in logout flow
- **Startup Cleanup**: Delete existing NULL expiry sessions on application startup
- **Prevention**: Runtime fix prevents new NULL expiry sessions from being created
- **Remediation**: Startup cleanup handles historical bad data

### Impact
- Logout flow no longer creates NULL expiry sessions
- Startup cleanup handles legacy data with minimal performance overhead
- Prevents TypeError crashes during session validation
- Complete solution addressing both root cause and symptoms
- No dependency on Flask-Session 0.5.1 release timeline

## Appendix: Internationalization Implementation

### Components Updated
The following components received internationalization fixes:

1. **Balance.tsx**: "Current Balance", "Loading balance..."
2. **PriceChart.tsx**: "Loading chart data...", "Failed to load chart data"
3. **PriceUploadForm.tsx**: "Select Date", "Select Session", "Price", "Upload Price", "Uploading..."
4. **Recharge.tsx**: "Recharge Amount", "Amount", "Recharge", "Recharging..."
5. **SellerList.tsx**: "Available Sellers", "Loading sellers...", "Failed to load sellers", "Latest Price", "View Chart", "No price data"
6. **SellerSettings.tsx**: "Seller Settings", "Loading settings...", "Save Settings", "Saving..."
7. **TradeForm.tsx**: "Loading...", "Buy", "Sell", "Trading..."
8. **TradeHistory.tsx**: "Trade History", "Loading trade history...", "Failed to load trade history"
9. **Login.tsx**: Various authentication-related strings
10. **Register.tsx**: Registration form labels and messages

### Translation File Structure
Translation keys follow component-scoped naming:

```json
{
  "balance": {
    "currentBalance": "Current Balance",
    "loading": "Loading balance..."
  },
  "priceChart": {
    "loading": "Loading chart data...",
    "error": "Failed to load chart data"
  }
}
```

### Language Support
- **English (en.json)**: Complete translation coverage
- **Chinese (zh.json)**: Complete Chinese translations for all keys
